window.x={debug:document.location.host.indexOf(".ru")!=document.location.host.length-3};var setItem=function(i,v){if(window.x["debug"]&&typeof window.x[i]!="undefined"&&typeof console!="undefined"&&window.x[i]!=v)console.log("Value of item "+i+" has changed from "+window.x[i]+" to "+v);window.x[i]=v};var getItem=function(i){if(window.x["debug"]&&typeof window.x[i]=="undefined"&&typeof console!="undefined")console.warn("Value of item "+i+" is undefined (maybe was not set?)");return window.x[i]};(function($){$.fn.outerHTML=function(s){return s?this.before(s).remove():$("&lt;p&gt;").append(this.eq(0).clone()).html()}})(jQuery);var urs=window.location.protocol==="https:"?"https:":"http:";$.dromDomains={sales:urs+"//auto.drom.ru/",reviews:urs+"//www.drom.ru/reviews/",travel:urs+"//travel.drom.ru/",news:urs+"//news.drom.ru/",new:urs+"//new.drom.ru/",vkontakte:urs+"//share.drom.ru/",www:urs+"://www.drom.ru/"};$.salesIsCityDomain=false;$.isSales=$.isWWW=$.isVkontakte=false;$.isCrossDomainRequest=false;if(window.location.href.indexOf($.dromDomains.sales)!==-1){$.ajaxRequestDir=$.dromDomains.sales;$.isSales=true}else if(window.location.href.indexOf($.dromDomains.vkontakte)!==-1){$.ajaxRequestDir=$.dromDomains.vkontakte+"ajax/";$.isVkontakte=true}else if(window.location.href.indexOf($.dromDomains.www)!==-1){$.ajaxRequestDir=$.dromDomains.www;$.isWWW=true}else{$.ajaxRequestDir="/auto/";$.isCrossDomainRequest=true;$.salesIsCityDomain=true;$.isSales=true}$.isIe67=$.browser.msie&&($.browser.version=="6.0"||$.browser.version=="7.0");(function($){$.fn.loading=function(options){var defaults={loadingText:options.loadingText?options.loadingText:"Loading",fin:options.fadeInDuration?options.fadeInDuration:400,fout:options.fadeOutDuration?options.fadeOutDuration:600,dots:typeof options.trailingDots!=="undefined"?options.trailingDots:0},obj=$(this);options=jQuery.extend(defaults,options);setInterval(function(){$(obj).animate({opacity:.25},options.fout).animate({opacity:1},options.fin)},options.fin+options.fout);if(options.dots!==0){setInterval(function(){var s=$(obj).text();var ns=s.replace(options.loadingText,"");if(ns.length>=options.dots)$(obj).text(options.loadingText);else $(obj).text(s+".")},300)}};$.fn.setStatusBox=function(x){$(this).html("&nbsp;&nbsp;").append(x)};$.sendCodeSMS=function(options){var _d=$.extend({},options.data);if($.isCrossDomainRequest){_d["crossdomain_ajax_request"]=2;_d["request"]="send_sms"}var xhr=jQuery.ajax({async:true,cache:false,url:$.ajaxRequestDir+($.isCrossDomainRequest?"":"send_sms.php"),data:_d,dataType:"xml",error:function(){return false},beforeSend:options.beforeLoad,success:options.afterLoad});return xhr}})(jQuery);(function($){$.drawGetContactsBox=function(options){var divid="modal_"+options.id,causeid=divid+"_cause",closeid=divid+"_close",ww=jQuery(window).width(),wh=jQuery(window).height(),modaldef={height:(typeof options.height).toLowerCase()=="integer"?options.height:300,width:(typeof options.width).toLowerCase()=="integer"?options.width:450},box;if($("#"+divid).length){box=$("#"+divid)}else{box=$('<div id="'+divid+'" class="modal">\n      <img onclick="javascript: jQuery.mask.close(); " src="//c.rdrom.ru/img_tpl/lightbox/close.png" id="'+closeid+'" style="float: right; cursor: pointer;" title="Закрыть" />      <h1>Получение контактных данных объявления</h1>\n      <p>Контактные данные автора объявления скрыты, так как <span id="'+causeid+'">'+options.cause+'</span>.</p>\n      <p>Чтобы получить контактные данные, нужно отправить SMS:</p>\n      <p><h3 style="display: inline">drom с'+options.bull_id+'</h3> на номер <h3 style="display: inline">4446</h3></p>\n      <p>Контактные данные будут отправлены вам в ответном сообщении в течение 5 минут.</p>\n      <p>Стоимость сообщения на номер 4446 зависит от оператора и составляет для большинства операторов 28-30 руб. без НДС (<a href=http://rates.planet3.ru/Ext.aspx>уточните цены для всех операторов подробнее</a>)</p></div>');$(document.body).append(box)}if($.isIe67){box.css("position","absolute")}box.css({width:modaldef.width,height:modaldef.height,left:typeof options.x!="undefined"?options.x:Math.abs(Math.ceil(ww/2-modaldef.width/2)),top:typeof options.y!="undefined"?options.y:Math.abs(Math.ceil(wh/2-modaldef.height/2))});box.expose({color:"#AAA",loadSpeed:"fast",onBeforeClose:function(){this.getExposed().css("display","none")},onLoad:function(){this.getExposed().css("display","block")}})};$.drawApproveBox=function(options){var modaldef={height:(typeof options.height).toLowerCase()=="integer"?options.height:200,width:(typeof options.width).toLowerCase()=="integer"?options.width:420},id=options.id,modal_id="modal_"+id,modal_close_id="modal_close_"+id,modal_text_id="modal_text_"+id,modal_approve_code_id="modal_approve_code_"+id,modal_stale_remind_id="modal_stale_remind_"+id,modal_approve_btn_id="modal_approve_btn_"+id,modal_code_remind_id="modal_code_remind_"+id,modal_messagebox_id="modal_messagebox_"+id,initial_text=typeof options.initial_text=="undefined"?"":options.initial_text,box=$("#"+modal_id),box_exists=box.length;if(!box_exists){box=$('<div id="'+modal_id+'" class="modal">\t<img onclick="javascript: jQuery.mask.close(); " src="//c.rdrom.ru/img_tpl/lightbox/close.png" id="'+modal_close_id+'" style="float: right; cursor: pointer;" title="Закрыть" />  <p id="'+modal_text_id+'">'+initial_text+'</p>  <div>Код: <input type="text" value="" name="approve_code" id="'+modal_approve_code_id+'" maxlength="6" size="10" /></div>  <div id="'+"bull_remind_"+modal_messagebox_id+'"><label><input type="checkbox" style="position: relative;" name="approve_stale_bulls_remind" id="'+modal_stale_remind_id+'" value="1" checked="checked" /> Присылать мне напоминания, если объявление устарело</label></div>  <div><input type="button" id="'+modal_approve_btn_id+'" value="Подтвердить" /> <span style="display: none; position: relative;" class="clickable" id="'+modal_code_remind_id+'">Запросить код повторно</span></div>  <div id="'+modal_messagebox_id+'" style="font-weight: bold;"></div></div>');$(document.body).append(box)}var close=$("#"+modal_close_id),text=$("#"+modal_text_id),code=$("#"+modal_approve_code_id),remind_stale=$("#"+modal_stale_remind_id),approve=$("#"+modal_approve_btn_id),code_remind=$("#"+modal_code_remind_id),messagebox=$("#"+modal_messagebox_id);if(box_exists){text.html(initial_text)}if(options.show_code_remind){code_remind.show()}else{code_remind.hide()}if(typeof options.show_bull_remind!==undefined&&options.show_bull_remind===false){$("#"+"bull_remind_"+modal_messagebox_id).hide()}approve.unbind("click").bind("click",function(){var _d={};if($.isCrossDomainRequest){_d["crossdomain_ajax_request"]=2;_d["request"]="phone_approve"}var $phone1=jQuery("#"+id).val().replace(/\D/g,"");if($("#regionid").val()===102&&$("#krym_phone_1_code").length!==0){$phone1=$("#krym_phone_1_code").val()+$phone1}$.ajax({async:true,url:$.ajaxRequestDir+($.isCrossDomainRequest?"":"phone_approve.php"),data:$.extend({code:code.val().replace(/\D/g,""),phone:$phone1,stale_bulls_remind:remind_stale.attr("checked")?1:0},_d),success:function(xml){var $xml=$(xml),error=parseInt($xml.find("error").text(),10),message=$xml.find("message").text(),user_authenticated=$xml.find("user_authenticated").text(),user=user_authenticated&&$.parseJSON($xml.find("user").text())||undefined;if(user_authenticated){$(document).trigger("user_authenticated",[user])}if(error===0){setApprovePhoneState(options.id,1);jQuery("#box_"+id).setStatusBox(jQuery('<b style="color: green">Подтвержден</b>'));jQuery("#"+id).trigger("approved");jQuery.mask.close()}else{setApprovePhoneState(options.id,0);messagebox.text(message)}}})});code_remind.unbind("click").bind("click",function(){messagebox.text("");var loadingBox=$.createLoadingBox({id:code_remind.attr("id")+"_lb",text:"Отправляем запрос"});var $phone1=jQuery("#"+id).val().replace(/\D/g,"");if($("#regionid").val()===102&&$("#krym_phone_1_code").length!==0){$phone1=$("#krym_phone_1_code").val()+$phone1}$.sendCodeSMS({data:{phone:$phone1,type:typeof options.sms_type=="undefined"?"phone_code_remind":options.sms_type,mid:jQuery('select[name="modelid"] option:selected').val()},beforeLoad:function(){code_remind.hide().after(loadingBox)},afterLoad:function(xml){loadingBox.remove();code_remind.remove();var $xml=$(xml);var error=$xml.find("error").text();var user_message=$xml.find("user_message").text();var _alert=$xml.find("alert").text();if(_alert.length>0)alert(_alert);messagebox.text(user_message)}})});var ww=jQuery(window).width();var wh=jQuery(window).height();if($.isIe67){box.css("position","absolute")}box.css({width:modaldef.width,height:modaldef.height,left:typeof options.x!="undefined"?options.x:Math.abs(Math.ceil(ww/2-modaldef.width/2)),top:typeof options.y!="undefined"?options.y:Math.abs(Math.ceil(wh/2-modaldef.height/2))});box.expose({color:"#AAA",loadSpeed:"fast",onBeforeClose:function(){this.getExposed().css("display","none")},onLoad:function(){this.getExposed().css("display","block")}})}})(jQuery);var setValidatePhoneState=function(id,state){setItem(id,state)};var getValidatePhoneState=function(id){return getItem(id)};var setApprovePhoneState=function(id,state){setItem("p"+id,state)};var getApprovePhoneState=function(id){return getItem("p"+id)};$.createLoadingBox=function(options){if(typeof options.id=="undefined")return false;if(jQuery("#"+options.id).length){var obj=jQuery("#"+options.id);if(obj.text()!=options.text){obj.text(options.text)}return obj}if((typeof options.text).toLowerCase()!="string")return false;var le=jQuery("<span>"+options.text+"</span>");le.attr("id",options.id+"_le");var show_loading_circle=typeof options.dont_show_loading_circle!=="undefined"&&options.dont_show_loading_circle!==true;var lb=jQuery("<span></span>").html(le).attr("id",options.id);if(show_loading_circle)lb.addClass("loading");le.loading({loadingText:options.text,trailingDots:typeof options.trailingDots!="undefined"?options.trailingDots:0});return lb};(function($){var settings={};var checkPhone=function(p,beforeSend){var phone=new Phone(p),ajax_data={phone:phone.normalize()},beforeSend=typeof beforeSend==="function"?beforeSend:$.noop;if(settings.hasOwnProperty("context")){ajax_data["context"]=settings.context}if($.isCrossDomainRequest){ajax_data["crossdomain_ajax_request"]=2;ajax_data["request"]="check_phone"}return $.ajax({async:true,url:$.ajaxRequestDir+($.isCrossDomainRequest?"":"check_phone.php"),cache:false,dataType:"xml",type:"GET",data:ajax_data,beforeSend:beforeSend})};var getBoxByPhoneId=function(id){var x=$("#box_"+id);if(x.length){return x}else{return false}};var showModalApprove=function(id){var phone=new Phone($("#"+id).val()),src=urs+"//baza.drom.ru/personal/approve_phone/?phone="+phone.normalize()+"&mode=api&from=drom&straight=1";console.log("modal approve is goind to be created, received id "+id);$.fancybox.open({href:src,data:{id:id},type:"iframe",autoCenter:true,autoResize:true,autoWidth:true,autoSize:true,fitToView:true,maxWidth:800,minHeight:750,tpl:{closeBtn:'<a title="Закрыть" class="fancybox-item fancybox-close" href="javascript:;"></a>'},padding:0,helpers:{title:false},nextEffect:"none",prevEffect:"none",openEffect:"none",closeEffect:"none",scrolling:false,arrows:false,scrollOutside:true,beforeClose:function(){$(document).trigger("closingFancybox");$.fancybox.hideLoading();setTimeout(function(){$("html").removeAttr("style");$("body").removeAttr("style")},210)},beforeLoad:function(){var div=$('<div style="position: fixed; top: 0px; left: 0px; height: 60px; width: 100%; visibility: hidden; overflow-y: scroll;"></div>'),width=0;$("body").append(div);div.append($('<div style="width: 100%; height: 100px;"></div>'));width=div.width()-div.find("div").width();div.remove();$("html").css("overflow","hidden");$("body").css("paddingRight",width)}})};var drawPhoneBox=function(id,isFpa){var vs=getValidatePhoneState(id),isFpa=isFpa||false;if(vs==$.fn.salesPhone.defaults.need_enter_code_empty||vs==$.fn.salesPhone.defaults.need_enter_code){var appr=$("<span>Подтвердить по SMS</span>").css("color","#555");getBoxByPhoneId(id).setStatusBox(appr.removeAttr("style").addClass("clickable"));setApprovePhoneState(id,0);var _it="";if(vs==$.fn.salesPhone.defaults.need_enter_code_empty){_it="На ваш телефон отправлено sms-сообщение                с кодом на подтверждение. Введите код в форму ниже. Услуга бесплатна!"}else{_it="Вы ранее уже размещали объявления.            Если вы помните код на подтверждение, присланный вам по sms,            введите его в форму ниже, либо запросите код повторно"}var _id=id;var $phone1=$("#"+id).val().replace(/\D/g,"");if($("#regionid").val()===102&&$("#krym_phone_1_code").length!==0){$phone1=$("#krym_phone_1_code").val()+$phone1}appr.bind("click",function(obj){if(isFpa){console.log("should approve on farpost, so I am creating a farpost iframe");showModalApprove(_id)}else{if(vs==$.fn.salesPhone.defaults.need_enter_code_empty){$.sendCodeSMS({data:{phone:$phone1,type:typeof settings.sms_type=="undefined"?"phone_code":settings.sms_type,mid:jQuery('select[name="modelid"] option:selected').val()},beforeLoad:function(){},afterLoad:function(){}})}$.drawApproveBox({id:_id,initial_text:_it,show_code_remind:vs==$.fn.salesPhone.defaults.need_enter_code,show_bull_remind:typeof settings.show_bull_remind=="undefined"?true:settings.show_bull_remind,sms_type:typeof settings.sms_type=="undefined"?"phone_code_remind":settings.sms_type,x:($(window).width()-420)/2,y:$.isIe67?obj.clientY+$(window).scrollTop():obj.clientY})}})}else if(vs==$.fn.salesPhone.defaults.no_need_enter_code){getBoxByPhoneId(id).setStatusBox($('<b style="color: green">Подтвержден</b>'));setApprovePhoneState(id,1)}else if(vs==$.fn.salesPhone.defaults.broken_operator_phone){getBoxByPhoneId(id).setStatusBox($(""));setApprovePhoneState(id,1)}};window.onmessage=function(e){var msg="Message received: "+e.data;console.log(msg);switch(e.data){case"approve_phone_cancel":$("#"+$.fancybox.current.data.id).focus();$.fancybox.current.data["shouldCheckPhone"]=false;$.fancybox.close();break;case"approve_phone_success":$.fancybox.current.data["shouldCheckPhone"]=true;$.fancybox.close();break}};$(document).on("closingFancybox",function(){var phone=new Phone($("#"+$.fancybox.current.data.id).val()),id=$.fancybox.current.data.id;if($.fancybox.current.data.shouldCheckPhone){checkPhone(phone.normalize()).done(function(response){var $response=$(response),state=$response.find("status").text(),$fpa=$response.find("fpa"),fpa=$fpa.length===0?false:!!$fpa.text();console.log("checking phone on farpost");setValidatePhoneState(id,state);drawPhoneBox(id,true)})}});$.fn.salesPhone=function(options){settings=$.extend($.fn.salesPhone.defaults,options);var validate=function(obj,evt){var id=typeof obj.data.id!="undefined"?obj.data.id:this.id;if(!obj.data.dont_check_key_code){var kc=obj.which||obj.keyCode}var value=typeof obj.data.id!="undefined"?jQuery("#"+obj.data.id).val():this.value;var sn=value.replace(/\D/g,"");if(parseInt($("#regionid").val())===102&&$("#krym_phone_1_code").length!==0){sn=$("#krym_phone_1_code").val()+sn}var phone_ok=false,loadingBox;if($("#"+id+"_lb").length){loadingBox=$("#"+id+"_lb")}else{loadingBox=$.createLoadingBox({id:id+"_lb",text:"Проверка телефона"})}if(Phone.isValid(sn)){phone_ok=true}if(phone_ok){if(!obj.data.dont_check_key_code&&(kc>57&&kc<96||kc<48||kc>105)&&kc!=8&&kc!=46&&kc!=32&&kc!=13&&kc!=229){return}checkPhone(sn,function(){if(loadingBox.length>0)obj.data.box.setStatusBox(loadingBox)}).done(function(response){var $response=$(response),state=$response.find("status").text(),$fpa=$response.find("fpa"),fpa=$fpa.length===0?false:!!$fpa.text();setValidatePhoneState(id,state);drawPhoneBox(id,fpa)})}else{setValidatePhoneState(id,null);setApprovePhoneState(id,0);if((typeof xhr).toLowerCase()=="object"){xhr.abort()}loadingBox.remove();obj.data.box.setStatusBox($("<span>Подтвердить по SMS</span>").css("color","#555"))}};this.each(function(index){if(getItem("sp_set_"+this.id)==1){return}setItem("sp_set_"+this.id,1);var $this=$(this);var spanbox=$("<span></span>").attr("id","box_"+this.id);$this.after(spanbox);if(settings.approved&&$this.val().length>0){setApprovePhoneState(this.id,1);spanbox.setStatusBox($('<b style="color: green">Подтвержден</b>'));setValidatePhoneState(this.id,64)}else{spanbox.setStatusBox($("<span>Подтвердить по SMS</span>").css("color","#555"));setValidatePhoneState(this.id,null);validate({data:{box:spanbox,dont_check_key_code:0,id:$this.attr("id")}})}$this.unbind("keyup input").bind("keyup input",{box:spanbox,dont_check_key_code:0},validate)})};$.fn.salesPhone.defaults={check_phone:"Проверка телефона",sending_sms:"Отправляем SMS",phone_approved:'<b color="green">Телефон подтвержден</b>',unable_send_sms:'<b color="red">Не удалось отправить SMS</b>',need_enter_code_empty:16,need_enter_code:32,no_need_enter_code:64,broken_operator_phone:128}})(jQuery);(function($){$.fn.unbindSalesPhone=function(){this.each(function(index){setItem("sp_set_"+this.id,0);var $this=$(this);if(jQuery("#box_"+this.id).length){jQuery("#box_"+this.id).remove()}setApprovePhoneState(this.id,1);$this.unbind("keyup")})}})(jQuery);var _requireCssCache={};function requirecss(file){var cacheKey=file.match(/[a-z]+/g).join("");if(_requireCssCache[cacheKey])return;_requireCssCache[cacheKey]=1;var link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=file;document.getElementsByTagName("head")[0].appendChild(link)}
